# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- `src/` — исходные файлы проекта
- `src/components/` — папка с JS компонентами
- `src/components/base/` — папка с базовым кодом
- `src/components/common/` — папка с родительскими компонентами
- `src/components/connector/` — папка с коннекторами
- `src/components/model/` — папка с моделями данных
- `src/components/view/` — папка с моделями представлений

Важные файлы:
- `src/pages/index.html` — HTML-файл главной страницы
- `src/types/index.ts` — файл с типами
- `src/index.ts` — точка входа приложения
- `src/scss/styles.scss` — корневой файл стилей
- `src/utils/constants.ts` — файл с константами
- `src/utils/utils.ts` — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```bash
  npm install
  npm run start
```

или

```bash
  yarn
  yarn start
```
## Сборка

```bash
  npm run build
```

или

```bash
  yarn build
```

## Данные и типы данных, используемые в приложении

Карточка, получаемая с сервера
```ts
interface ICard {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null;
}
```

Расширение данных карточки используемых в нашем приложении
```ts
interface ICardWithSelection extends ICard {
  selected: boolean;
}
```

Интерфейс для модели данных коллекции каталога
```ts
interface ICatalogDataState {
  cards: ICardWithSelection[];
}
```

Пользователь
```ts
interface IUser {
  payment?: string;
  email?: string;
  phone?: string;
  address?: string;
}
```

Интерфейс для модели данных пользователя
```ts
interface IUserDataState {
  user: IUser;
}
```

Данных для отправки заказа на сервер
```ts
interface IOrder extends IUser {
  total: number;
  items: string[];
}
```

Данные получаемые с сервера при успешном заказе
```ts
interface IOrderSuccess {
  id: string;
  total: number;
}
```

Тип данных карточки для отображения в каталоге
```ts
type TCardCatalog = Omit<ICard, 'id' | 'description'>;
```

Тип данных карточки для отображения в модальном окне
```ts
type TCardPreview = Omit<ICard, 'id'>;
```

Тип данных карточки для отображения в корзине
```ts
type TCardBasket = Pick<ICard, 'title' | 'price'>;
```

Тип данных пользователя для отображения в форме заказа
```ts
type TUserOrder = Pick<IUser, 'payment' | 'address'>;
```

Тип данных пользователя для отображения в форме контактов
```ts
type TUserContacts = Pick<IUser, 'phone' | 'email'>;
```

## Архитектура приложения
В качестве паттерна для построения архитектуры приложения, выбран MVP (Model-View-Presenter).
MVP разделяет приложение на три основных компонента:
- Модель (Model) — представляет бизнес-логику приложения и данные.
- Представление (View) — отображает данные пользователю и обрабатывает пользовательский ввод.
- Презентер (Presenter) — является посредником между моделью и представлением. Модель и представление взаимодействуют только через презентер.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

#### Класс Model
В параметры конструктора класса передается интерфейс IEvents. Базовая модель, чтобы можно было отличить ее от простых объектов с данными.

#### Класс Component
Базовый класс для использования в классах представления VIEW. Имеет необходимые методы для управления разметкой. А также метод для вывода готовой разметки в DOM.

### Слой данных

#### Класс CatalogData
Класс отвечает за хранение и логику работы с данными карточек.\
Конструктор класса принимает объект для реализации его в базовом классе Model и инстант брокера событий.\
Класс предоставляет набор методов для взаимодействия с данными:
- `setCards(data: ICard[]): void` - добавляет массив карточек, получаемых с сервера, а так же добавляет новое свойство `selected` со значением `false` к каждой карточке, по которому мы будем понимать, выбрана ли карточка.
- `getCards(): ICardWithSelection[]` - получение всех карточек. Будем получать со всеми имеющимися свойствами.
- `getCard(id: string): ICardWithSelection` - получение одной карточки по id.
- `toggleCardSelected(id: string): void` - переключение значения свойства `selected` в карточке по её id.
- `getSelectedCards(): ICardWithSelection[]` - получение массива всех выбранных карточек.
- `getSelectedCardIds(): string[]` - получение массива id всех выбранных карточек.
- `getSelectedCardsCount(): number` - колучение колличества выбранных карточек.
- `getTotalPriceOfSelectedCards(): number ` - получение суммы цен всех выбранных карточек.
- `clearSelection(): void` - убираем выбор для всех карточек.
- `isPriceNotNull(id: string): boolean` - проверяем цену в карточке на пустоту.

#### Класс UserData
Класс отвечает за хранение и логику работы с данными пользователя.\
Конструктор класса принимает объект с ошибками, в которых будет хранить значения валидации данных, объект с данными для реализации его в базовом классе Model и инстант брокера событий.\
Класс предоставляет набор методов для взаимодействия с данными:
- `setUserData(field: keyof IUser, value: string): void` - установку значений данных пользователя.
- `getPayment(): string` - получение способа оплвты.
- `getEmail(): string` - порлучение email пользователя.
- `getPhone(): string` - получение телефона.
- `getAddress(): string` - получение адреса.
- `validateUserData(): void` - валидация данных пользователя и запись ошибок в объект errors.
- `clearUserData(): void` - очистка всех данных пользователя.


### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Родительский класс Modal
Реализует модальное окно для любой передаваемой в него HTML-разметки. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.  
- `constructor(protected container: HTMLElement, protected events: IEvents)` - конструктор принимает контейнер, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.

реализует интерфейс:
```ts
interface IModal {
  content: HTMLElement;
}
```

#### Родительский класс Card
Расширяемый класс карточки товара для всех возможных отображений в приложении.\
Поля класса:
- `_title: HTMLElement` - заголовок карточки.
- `_price: HTMLElement` - цена продукта.
- `_id: string` - id карточки, для верной работы броккера событий.

Методы:
- `set title(value: string): void` - для установки заголовка.
- `set price(value: number | null): void` - для установки цены.
- `set id(value: string): void` - для записи id карточки.
- `get id(): string` -геттер для получения id карточки.

#### Класс CardCatalog
Класс представления карточки в каталоге.\
Поля класса:
- `_category: HTMLElement` - категория товара
- `_image: HTMLImageElement` - картинка товара
- `_button: HTMLButtonElement` - кнопка добавления/удаления из корзины
- `categoryValue: Record<string, string>` - объект с класссами стилей для цвета категории

Методы:
- `set category(value: string): void` - установка категории
- `set image(value: string): void` - установка изображения

#### Класс CardPreview
Класс представления детальной карточки. Расширяет класс CardCatalog.\
Поля класса:
- `_description: HTMLElement` - описание товара

Методы:
- `set description(value: string): void` - установка описания товара
- `set buttonText(value: boolean): void` - изменения текста кнопки
- `set buttonState(value: boolean): void` - изменения состояния кнопки

#### Класс CardBasket
Класс представления карточки в корзине.\
Поля класса:
- `_button: HTMLButtonElement` - кнопка удаления из корзины
- `protected _index: HTMLElement` - элемент порядкового номера товара в корзине

Методы:
- `set index(value: number): void` - установка порядкового номера товара в корзине

#### Родительский класс Form
Расширяемый класс любой формы.\

реализует интерфейс:
```ts
interface IFormState {
  valid: boolean;
  errors: string[];
}
```

Поля класса:
- `submit: HTMLButtonElement` - кнопка сабмита
- `_errors: HTMLSpanElement` - элемент для вывода ошибки

Методы:
- `handleInput(event: Event): void` - колбэк-функция для изменений в поле ввода
- `handleSubmit(event: Event): void` - колбэк-функция отправки данных формы
- `onInputChange(field: keyof T, value: string): void` - обработчик изменения значения в поле формы.
- `set valid(value: boolean): void` - сеттер для установки состояния кнопки
- `set errors(value: string): void` - сеттер для вывода ошибки в форме
- `reset(): void` - сброс формы
- `render(state?: Partial<T> & IFormState): void` - рендер содержимого формы

#### Класс UserContacts
Класс представления формы контактов пользователя.\

Методы:
- `reset(): void` - сброс формы

#### Класс UserOrder
Класс представления формы заказа пользователя.\
Поля класса:
- `_buttons: HTMLButtonElement[]` - массив кнопок оплаты

Методы:
- `setPayment(name: string): void` - установка способа оплаты
- `clearPayment(): void` - сброс способа оплаты
- `reset(): void` - сброс данных формы

#### Класс Page
Класс представления главной страницы с контейнером для карточек и счетчиком корзины.\

реализует интерфейс:
```ts
interface IPage {
  cardsList: HTMLElement[];
  basketCounter: number;
}
```

Поля класса:
- `cardsContainer: HTMLElement` - контейнер для карточек
- `basketCounterElement: HTMLElement` - элемент каунтера корзины
- `basketButtonElement: HTMLButtonElement` - кнопка корзины

Методы:
- `set cardsList(items: HTMLElement[]): void` - сеттер учтановки массива HTML-элементов карточек
- `set basketCounter(value: number): void` - сеттер каунтера кол-ва товаров на корзине

#### Класс Basket
Класс представления корзины со списком товаров в ней, а так же вывода итоговой стоимости этих товаров.\

реализует интерфейс:
```ts
interface IBasket {
  items: HTMLElement[];
  total: number;
}
```

Поля класса:
- `listElement: HTMLElement` - контейнер для добавления элементов карточек
- `totalPriceElement: HTMLElement` - элемент с итоговой стоимостью
- `buttonOrderElement: HTMLButtonElement` - кнопка перехода к оформлению заказа

Методы:
- `set items(cardsSelected: HTMLElement[]): void` - вывод списка товаров корзины
- `set total(value: number): void` - вывод итоговой стоимости заказа
- `set buttonState(value: boolean): void` - изменение состояния кнопки

#### Класс Success
Класс представления успешного оформления заказа.\

реализует интерфейс:
```ts
interface IOrderSuccess {
  id: string;
  total: number;
}
```

Поля класса:
- `_total: HTMLElement` - элемент вывода итоговой стоимости 
- `button: HTMLButtonElement` - кнопка закрытия окна

Методы:
- `set total(value: number): void` - вывод итоговой суммы заказа в окне

### Слой коммуникации

#### Класс WebLarekApi
Принимает в конструктор экземпляр класса который реализует интерфейс IApi и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

```ts
interface IApi {
  baseUrl: string;
  get<T>(uri: string): Promise<T>;
  post<T>(uri: string, data: object, method?: ApiPostMethods): Promise<T>;
}
```

- `getProductsApi(): Promise<ICard[]>` - получение массива карточек с сервера
- `postOrderApi(orderData: IOrder): Promise<IOrderSuccess>` - post-запрос отправки данных заказа и получение либо успешного ответа от сервера, либо конкретных ошибок в нарушении данных.

## Процесс работы приложения:

1. Инициализация главной страницы
   - Загрузка списка карточек товаров из модели CatalogData
   - Отображение карточек в компоненте Page
   - Отображение количества товаров на иконке корзины

2. Просмотр карточки товара
   - При выборе карточки (событие 'cardCatalog:openPreview'):
     - Отображение детальной информации карточки
     - Проверка и изменения состояния выбора карточки - добавление/удаление из корзины
     - Настройка кнопки "Купить/Убрать" в зависимости от состояния выбора карточки
   - Деактивация кнопки при нулевой цене

3. Просмотр корзины
   - При открытии корзины:
     - Загрузка данных из CatalogData
     - Отображение списка товаров и общей суммы в компоненте "Корзина"

4. Управление товарами в корзине
   - Удаление товара:
     - Вызов метода изменения состояния выбора
     - Обновление отображения корзины

5. Оформление заказа
   - Форма заказа:
     - Отображение формы оплаты и доставки
     - Валидация данных
     - Активация кнопки "Далее" при успешной валидации
   - Форма контактов:
     - Отображение формы контактных данных
     - Валидация данных
     - Активация кнопки "Оплатить" при успешной валидации

6. Завершение заказа
   - При нажатии "Оплатить":
     - Создание нового заказа на основе данных из UserData и CatalogData
     - Отправка данных заказа на сервер
     - Отображение окна успешного оформления заказа
     - Очистка данных форм, данных пользователя, а также отмена выбора у карточек

7. Возврат на главную страницу
   - При нажатии "За новыми покупками" возврат к начальному состоянию приложения

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

События, которые могут генерироваться в системе:
- `catalogData:init` - отоображение массива карточек загруженных с сервера.
- `catalogData:changed` - изменение данных в карточке, а именно выбранных карточек.
- `userData:errorsChange` - изменение валидации данных об ошибках.
- `userData:clear` - очистка данных пользователя.
  
События, возникающие при взаимодействии пользлователя с интерфейсом:
- `cardCatalog:openPreview` - открытие модалки с детальной информацией о продукте.
- `cardPreview:selectedChanged` - изменеие состояния выбора товара.
- `basket:open` - открытие корзины с товарами.
- `cardBasket:selectedChanged` - изменения состояния выбора у карточки в корзине и обновлене списка товаров.
- `inputValue:changed` - изменение значения в любом из поллей ввода в форме.
- `basket:submit` - открытие формы с данными о заказе.
- `order:submit` - открытие формы с контактными данными.
- `contacts:submit` - формирование данных заказа и отправка на сервер.
- `success:close` - закрытие окна успешного заказа по кнопке.